<?php

	session_start();	// dzięki temu podstrona może korzystać ze zmiennych globalnych

	//Poniżej - przetważanie naszego formularza:
	if(isset($_POST['email'])) 	//Sprawdzam czy ktoś kliknął "zarejestruj"
	{								//teraz ustawiamy poprawność danych (jakie dane będą przyjmowane)
		//udana walidazja? Załóżmy, że tak (all testy ok)
		$all_OK=true;
		$_SESSION['resetpass']=false;
		
		// spr. poprawności adresu email
		$email=$_POST['email'];
		$emailB=filter_var($email, FILTER_SANITIZE_EMAIL);	 		//specjalny filtr stosowany do adresów mailowych
		if((filter_var($emailB,FILTER_VALIDATE_EMAIL)==false) || ($emailB!=$email)) //pierwsza walidacja mogła uciać litery, więc sprawdzam
		{
			$all_OK=false;
			$_SESSION['e_email']="Podaj poprawny adres e-mail";
		}
		
		//sprawdzenie czy podany e-mail istnieje w bazie
		require_once "connect.php";
		
		
		mysqli_report(MYSQLI_REPORT_STRICT);		// tu inf. że chcemy rzucać wyjątkami w przypadku błędów
		try 										// try/catch, coś jak "@" (do pomijania błędów)
		{					 										
			 $polaczenie=new mysqli($host, $db_user, $db_password, $db_name);   
			 if($polaczenie->connect_errno!=0)
				{
					throw new Exception(mysqli_connect_errno());
				}
				else
				{
					//Czy email już istnieje?
					$rezult=$polaczenie->query("SELECT id FROM uzytkownicy WHERE mail='$email'");	//sprawdzam maila tylko jeśli udało się połączyć - dlatego w if'ie - w "else"
					if(!$rezult) throw new Exception($polaczenie->error);			//gdy nie udalo się w ogole wyslac zapytania
					$ile_takich_maili=$rezult->num_rows;
					if($ile_takich_maili==0)
					{
						$all_OK=false;
						$_SESSION['e_email']="konto o podanym adresie e-mail nie istnieje";
					}
						
					
					//GDY ALL JEST OK (all warunki spełnione) - wysyłam link
					if($all_OK==true)
					{
						$cod=uniqid('kod'); // generowanie losowego kodu
						//$cod=password_hash($kod_spr, PASSWORD_DEFAULT); // zaszyfrowanie kodu
						if($rezult1=$polaczenie->query("UPDATE uzytkownicy SET COD='$cod' WHERE mail='$email'")) // wysłanie zapytania
						 {//jesli ok to wysylany zostaje email z linkiem do zmiany hasla 
							@$message = " Witaj! Ktoś poprosił o wygenerowanie nowego hasła dla konta: ".$email." Na aplikacji do zarządzania ludźmi. Jeśli jest to błąd, po prostu zignoruj tego e-maila, a nic się nie stanie. Twój kod to: ".$cod.". Aby ustawić nowe hasło, przejdź pod adres: http://localhost/app1php/rempasswindow.php?resetpaswd=yes&user";//UPDATE
	
							$headers='From: patappsandprojects@gmail.com';
							$headers.='Content-type: text/html; charset=utf-8'.PHP_EOL;
							$headers.='X-Mailer: PHP/'. phpversion();
							if(mail($email, "Nowe hasło - aplikacja do zarządzania ludźmi", $message,$headers))
							{
								echo '<p>Link do zmiany hasła został wysłany</p>';
								$_SESSION['resetpass']=true;
								
							}else
							{
								echo '<p>Wystąpił problem. Zgłoś sie do administratora.</p>';
							}
						 }else
						 {
							 echo '<p>Wystąpił problem z zapytaniem do bazy danych. Zgłoś sie do administratora.</p>';
						 }
					
					
					
						$polaczenie->close();		//NIE ZAPONIJ ZAMKNĄĆ POŁĄCZENIA!
					}
				}
		}
		catch(Exception $e)
		{
			echo '<span class="error"> Błąd serwera! Przepraszamy za niedogodności i prosimy spróbować w innym terminie! </span>';
			//echo '<br>Informacja developerska: '.$e;
		}
	}

?>

<!DOCTYPE HTML>
<html lang="pl-PL">
<head>
    <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale-=1">
    <link rel="stylesheet" href="css/style.css" type="text/css">
    <link rel="icon" href="images/favicon.png" type="image/x-icon">
    <title>Aplikacja do zarządzania ludźmi - przypomnienie hasła </title>
    </head>
<body>
    <div class="container">
        <div class="boxreminder">
            <form method="post">	<!-- nie piszę action=...., bo chcę by ten sam plik przetworzył wysłany form. -->
			Link do zmiany hasła zostanie wysłany na podany adres e-mail.
			
			<br> e-mail: <br><input type="text" class = "input1" name="email" placeholder="e-mail"
			value="<?php							//zapamiętywanie wpisanych danych
			if(isset($_SESSION['form_email'])) 		//w przypadku niepowodzenia rejestr. nie trzeba drugi raz all pisać
			{
				echo $_SESSION['form_email'];
				unset($_SESSION['form_email']);
			}
			?>">
			
			<?php
				if(isset($_SESSION['e_email']))
				{
					echo '<div class="error">'.$_SESSION['e_email'].'</div>';
					unset($_SESSION['e_email']);			//usuwam błąd, by po spełnieniu warunku nadal się nie pokazywał
				}
			?>
			
			<br> <input type="submit" value="potwierdź">
			<br><br>
			
			<?php
	   echo '<p>[<a href="index.php">wróć do strony logowania</a>]</p>';		//logout
	   
	   ?>
   
			
			</form>
		</div>
    </div>
    
    <script src=".js"></script>
    <!--w JS: console.log(document);-->
    </body>


</html>