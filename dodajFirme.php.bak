<?php

	session_start(); // dzięki temu podstrona może korzystać ze zmiennych globalnych
	
	if(!isset($_SESSION['zalogowany']))	//by uniknąć że ktoś niezalogowany wpisze kod w adresie i przejdzie na tą stronę
	{
		header('Location: index.php');
		exit();			// w takim przypadku przenieś na str main (zalogowaną) i pomiń poniższy kod (z tej str index)
	}else
	{
	
	
	
		//Poniżej - przetważanie naszego formularza:
		if(isset($_POST['pr_name']))	//Sprawdzam czy ktoś wpisał chociaz imie lub nazwisko
		{								
			$id_uzytkownika=$_SESSION['id_uzytkownika'];
			
			//udana walidazja? Załóżmy, że tak (all testy ok)
			$all_OK=true;
			
			
			// inputy
			$pr_name=$_POST['pr_name'];
			$pr_name=htmlentities($pr_name, ENT_QUOTES, "UTF-8");
						
			if(strlen($pr_name)<1)
			{
				$all_OK=false;
				$error_brakNameLubSurname="Wpisz nazwę firmy";
			}
			
				require_once "connect.php";
				
				mysqli_report(MYSQLI_REPORT_STRICT);		// tu inf. że chcemy rzucać wyjątkami w przypadku błędów
				try 										// try/catch, coś jak "@" (do pomijania błędów)
				{					 										
				 $polaczenie=new mysqli($host, $db_user, $db_password, $db_name);   
					if($polaczenie->connect_errno!=0)
					{
						throw new Exception(mysqli_connect_errno());
					}
					else
					{
					 //dodanie nowej firmy
						if($all_OK==true)
						{	
							if($polaczenie->query("INSERT INTO firmy VALUES(NULL, '$id_uzytkownika' ,'$pr_name')"))
							{
								header('Location: firmy.php');
								$_SESSION['dodanoPrKomunikat']="Pomyślnie dodano firmę";
							}
							else{
								throw new Exception($polaczenie->error);
							}
							
						}
						
						
						$polaczenie->close();		//NIE ZAPONIJ ZAMKNĄĆ POŁĄCZENIA!
					}
				}
				catch(Exception $e)
				{
					echo '<span class="error"> Błąd serwera! Przepraszamy za niedogodności i prosimy o rejestrację w innym terminie! </span>';
					echo '<br>Informacja developerska: '.$e;
				}
		
		}
	}
	
	?>

<!DOCTYPE HTML>
<html lang="pl-PL">
<head>
    <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale-=1">
    <link rel="stylesheet" href="css/style.css" type="text/css">
    <link rel="icon" href="images/favicon.png" type="image/x-icon">
    <title>Aplikacja do zarządzania ludźmi - pracownicy</title>
	</head>
<body>
    <div class="container">
		<div class="navbar">
			<nav> 
			<a href="zastepstwa.php">ZASTĘPSTWA</a>
			<a href="pracownicy.php">PRACOWNICY</a>
			<a href="historiaZastepst.php">HISTORIA ZASTĘPST</a>					
			</nav
		</div>
		
		
		<div class=box1>
			
		   <form method="post">
				<br>
		   
				<?php
				if(isset($error_brakNameLubSurname))
				{
					echo '<div class="error">'.$error_brakNameLubSurname.'</div>';
					unset($error_brakNameLubSurname);			//usuwam błąd, by po spełnieniu warunku nadal się nie pokazywał
				}
				?>
				
				<br> nazwa firmy:
				<br><input type="text" name="pr_name">
								
				<br><br> <input type="submit" value="dodaj">
		   </form>
	   
	   </div>

   
    </div>
    
   <!-- <script src="js/script1.js"></script> -->
    </body>


</html>